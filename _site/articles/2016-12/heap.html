<!DOCTYPE html>
<html lang="en">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MFGCXMJ');</script>
<!-- End Google Tag Manager -->
  
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Binary Heap</title>
  <meta name="description" content="Heap implementation in OCaml.">

  <!-- CSS files -->
  <link rel="stylesheet" href="http://channgo2203.github.io/css/font-awesome.min.css">
  <link rel="stylesheet" href="http://channgo2203.github.io/css/main.css">

  <link rel="canonical" href="http://channgo2203.github.io/articles/2016-12/heap">
  <link rel="alternate" type="application/rss+xml" title="Van Chan Ngo" href="http://channgo2203.github.io/feed.xml" />

  <!-- Icons -->
  <!-- 16x16 -->
  <link rel="shortcut icon" href="http://channgo2203.github.io/favicon.ico">
  <!-- 32x32 -->
  <link rel="shortcut icon" href="http://channgo2203.github.io/favicon.png">
</head>


<body>
  <div class="row">
    <div class="col s12 m3">
      <div class="table cover">
        

<div class="cover-card table-cell table-middle">
  
  <img src="http://channgo2203.github.io/img/avatar.jpg" alt="" class="avatar">
  
  <a href="http://channgo2203.github.io/" class="author_name">Van Chan Ngo</a>
  <span class="author_job">Computer Scientist and Software Engineer</span>
  <span class="author_bio mbm">Research interests are in formal methods, programming languages, compilers, and language-based security. I am a member of the Principles of Programming Group, School of Computer Science, Carnegie Mellon University.</span>
  <nav class="nav">
    <ul class="nav-list">
      <li class="nav-item">
        <a href="http://channgo2203.github.io/about.html">About</a>
        <span>/</span>
      </li>
      <li class="nav-item">
        <a href="http://channgo2203.github.io/research.html">Research</a>
        <span>/</span>
      </li>
       <li class="nav-item">
        <a href="http://channgo2203.github.io/publications.html">Publications</a>
        <span>/</span>
      </li>
      <li class="nav-item">
        <a href="http://channgo2203.github.io/pdfs/cv.pdf" target="_blank">CV</a>
      </li>
    </ul>
    <ul class="nav-list">
      <li class="nav-item">
        <a href="http://channgo2203.github.io/talks.html">Talks</a>
        <span>/</span>
      </li>
      <li class="nav-item">
        <a href="http://channgo2203.github.io/notes/">Notes</a>
        <span>/</span>
      </li>
      <li class="nav-item">
        <a href="http://channgo2203.github.io/categories/">Categories</a>
        <span>/</span>
      </li>
       <li class="nav-item">
        <a href="http://channgo2203.github.io/tags/">Tags</a>
      </li>
    </ul>
  </nav>
  <script type="text/javascript">
  // based on http://stackoverflow.com/a/10300743/280842
  function gen_mail_to_link(hs, subject) {
    var lhs,rhs;
    var p = hs.split('@');
    lhs = p[0];
    rhs = p[1];
    document.write("<a class=\"social-link-item\" target=\"_blank\" href=\"mailto");
    document.write(":" + lhs + "@");
    document.write(rhs + "?subject=" + subject + "\"><i class=\"fa fa-fw fa-envelope\"></i><\/a>");
  }
</script>
<div class="social-links">
  <ul>
    
      <li>
      <script>gen_mail_to_link('chan.ngo2203@gmail.com', 'Hello from website');</script>
      </li>
    
    
    
    
    <li><a href="http://linkedin.com/in/channgo2203" class="social-link-item" target="_blank"><i class="fa fa-fw fa-linkedin"></i></a></li>
    
    
    
    
    <li><a href="http://github.com/channgo2203" class="social-link-item" target="_blank"><i class="fa fa-fw fa-github"></i></a></li>
    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</div>

  <div class="social-links">
    <span class="author_bio mbm">Do one thing, and do it well.</span>
    <span class="author_bio mbm">-- Unix philosophy</span>
  </div>
</div>

      </div>
    </div>
    <div class="col s12 m9">
      <div class="post-listing">
        <script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<a class="author_job" href= "http://channgo2203.github.io/" >
  Home
</a>



<div id="post">
  <header class="post-header">
    <h1 title="Binary Heap">Binary Heap</h1>
    <span class="post-meta">
      <span class="post-date">
        1 DEC 2016
      </span>
      •
      <span class="read-time" title="Estimated read time">
  
  
    27 mins read
  
</span>

    </span>

  </header>

  <article class="post-content">
    <p>In this post, I will talk about the 
<a href="https://en.wikipedia.org/wiki/Heap_(data_structure)">heap data structure</a>, a specialized 
tree-based data structure. I will recall how it can be implemented in imperative languages. 
Finally, I will discuss how heap can be implemented with lists in functional languages 
and show that it does not satisfy the requirements. A tree-based implementation in OCaml 
will also be given in this post.</p>

<h2 id="heap-data-type">Heap data-type</h2>

<p>A (complete) binary (min) heap is a binary tree that satisfies the following conditions:</p>

<ul>
  <li>
    <p><strong>Shape property</strong>: it is a complete binary tree; that is, all levels of the tree, 
except possibly the last one (deepest) are fully filled, and, if the last level of the 
tree is not complete, the nodes of that level are filled from left to right.</p>
  </li>
  <li>
    <p><strong>Heap property</strong>: the key stored in each node is less than or equal to the keys in 
the node’s children, according to some total order.</p>
  </li>
</ul>

<p>Figure 1 shows an example of a complete binary min heap, the numbers represent the value 
of the keys in the nodes.</p>

<p><img src="http://channgo2203.github.io/img/heap-1.jpg" alt="A heap" /></p>

<p>Heap is known for its efficient algorithms (logarithmic time complexity) of inserting 
and deleting the smallest element in implementing a priority queue. It is also used in 
implementing <a href="https://en.wikipedia.org/wiki/Heapsort">heapsort algoritm</a> that has <script type="math/tex">O(nlogn)</script> time complexity.</p>

<p>In imperative world, a heap is generally placed in an array with the layout of complete 
binary tree, mapping complete binary tree nodes to the array indices. For instance, with 
the zero-based array, the root node is represented by index <code class="highlighter-rouge">0</code>, if <code class="highlighter-rouge">i</code> is the index of 
the parent, then the indices of its left and right child are: <code class="highlighter-rouge">left_child(i) = 2*i + 1</code>
and <code class="highlighter-rouge">right_child(i) = 2*i + 1</code>. However, in functional languages, if we implement an array 
using list data-structure. Then we cannot obtain the constant time complexity for 
accessing elements of the array. Therefore, lists cannot be used to implement efficient 
heaps. Instead, we need to use tree data structures to implement heaps in functional world. 
The following will explain how we heaps are implemented in this way, especially how a new 
node is inserted into and the min node is removed from a heap with <script type="math/tex">O(logn)</script> time 
complexity.</p>

<p>A complete binary heap is represented by a complete binary tree that satisfies the heap 
property. A node can be a terminal node, called <code class="highlighter-rouge">Leaf</code> or a non-terminal node, called 
<code class="highlighter-rouge">Node</code>, that contains 
information about the number of nodes, the height, the key, its left and right trees. 
We will see that the number of nodes and the height help us decide to add a new node on 
the left or right child tree. The heap data-type is given in the following snippet.</p>

<div class="language-ocaml highlighter-rouge"><pre class="highlight"><code><span class="c">(** type of node value. *)</span>
<span class="k">type</span> <span class="n">key</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">t</span>

<span class="c">(** a node contains # nodes, height, left tree, key, and right tree. *)</span>
<span class="k">type</span> <span class="n">heap</span> <span class="p">=</span> <span class="nc">Leaf</span>
            <span class="p">|</span> <span class="nc">Node</span> <span class="k">of</span> <span class="kt">int</span> <span class="p">*</span> <span class="kt">int</span> <span class="p">*</span> <span class="n">heap</span> <span class="p">*</span> <span class="n">key</span> <span class="p">*</span> <span class="n">heap</span>
</code></pre>
</div>

<h2 id="insert-a-new-node">Insert a new node</h2>

<p>We consider an example of inserting <code class="highlighter-rouge">0</code> into the following integer heap. We first need to determine which direction for inserting, insert to the left subtree or to the right subtree, in order to satisfy the <strong>shape property</strong>. In this example, the left tree is full, so we should insert <code class="highlighter-rouge">0</code> into the right tree. We insert <code class="highlighter-rouge">0</code> to the bottom level of the heap. Because <code class="highlighter-rouge">0</code> is smaller than its parent, <code class="highlighter-rouge">6</code>, so we swap <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">6</code>. After swapping, it is obvious that <code class="highlighter-rouge">0</code> is smaller than <code class="highlighter-rouge">3</code>, thus we swap again <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">3</code>. Finally, <code class="highlighter-rouge">0</code> is smaller than <code class="highlighter-rouge">1</code>, so we swap <code class="highlighter-rouge">0</code> and <code class="highlighter-rouge">1</code>. At this point, the new heap satisfies both <strong>shape property</strong> and <strong>heap property</strong>.</p>

<p><img src="http://channgo2203.github.io/img/heap-2.jpg" alt="Insert" /></p>

<p>In general, we have the following algorithm that takes <script type="math/tex">O(logn)</script> runtime to insert a key into a heap.</p>

<ul>
  <li>
    <p>Since <script type="math/tex">% <![CDATA[
2^h <= n <= 2^{h+1} - 1 %]]></script>, if <script type="math/tex">n = 2^{h+1} - 1</script> (the tree is perfect complete) then insert to the left tree. Or if <script type="math/tex">% <![CDATA[
2^h <= n < 2^h + 2^{h-1} %]]></script> (the left tree is not full) then insert to the left tree. Otherwise insert to the right tree</p>
  </li>
  <li>
    <p>Add the new key to the bottom level of the heap</p>
  </li>
  <li>
    <p>Compare the added key with its parent, if they are in the correct order, then stop</p>
  </li>
  <li>
    <p>If not, swap it with its parent, then goto 3.</p>
  </li>
</ul>

<h2 id="remove-the-min-node">Remove the min node</h2>

<p>Assume that we want to remove the root of the following heap. We first replace the root with the last node on the bottom of the heap, meaning that the new root is now <code class="highlighter-rouge">11</code>. We then compare <code class="highlighter-rouge">11</code> with its children in order to make the <strong>heap property</strong> satisfied. Because <code class="highlighter-rouge">11</code> is bigger than the smallest child <code class="highlighter-rouge">2</code>, so we swap them. After that, <code class="highlighter-rouge">11</code> is bigger than the smallest child <code class="highlighter-rouge">4</code>, we swap them again. Now, <code class="highlighter-rouge">11</code> is bigger than the smallest child <code class="highlighter-rouge">8</code>, we finally swap them. At the end, we have a new heap that satisfies all conditions, namely <strong>shapre property</strong> and <strong>heap property</strong>.</p>

<p><img src="http://channgo2203.github.io/img/heap-3.jpg" alt="Remove" /></p>

<p>The <script type="math/tex">O(logn)</script> time complexity algorithm of removing the root from the heap is given as follows.</p>

<ul>
  <li>
    <p>Replace the root with the last node on the last level of the heap</p>
  </li>
  <li>
    <p>Compare the new root with its children, if they are in the correct order, then stop</p>
  </li>
  <li>
    <p>If not, swap the root with the smallest child, then goto 2</p>
  </li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>The full implementation is given below, in which many other utility functions for heap manipulation are provided.</p>

<div class="language-ocaml highlighter-rouge"><pre class="highlight"><code><span class="c">(************************************)</span>
<span class="c">(*              Heap                *)</span>
<span class="c">(*          Van Chan Ngo            *)</span>
<span class="c">(************************************)</span>

<span class="c">(** Implementation of binary heap over ordered types *)</span>

<span class="k">type</span> <span class="n">order</span> <span class="p">=</span> <span class="nc">Lt</span>
           <span class="p">|</span> <span class="nc">Eq</span>
           <span class="p">|</span> <span class="nc">Gt</span>
               
<span class="k">module</span> <span class="k">type</span> <span class="nc">OrderedType</span> <span class="p">=</span>
  <span class="k">sig</span>
    <span class="c">(** the type of the keys. *)</span>
    <span class="k">type</span> <span class="n">t</span>
    <span class="k">val</span> <span class="n">compare</span> <span class="p">:</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="n">order</span>
    <span class="k">val</span> <span class="n">to_string</span> <span class="p">:</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="kt">string</span>
  <span class="k">end</span>

<span class="k">module</span> <span class="k">type</span> <span class="nc">Heap</span> <span class="p">=</span>
  <span class="k">sig</span>
    <span class="c">(** the type of the elements. *)</span>
    <span class="k">type</span> <span class="n">key</span>
    <span class="c">(** the type of a heap. *)</span>
    <span class="k">type</span> <span class="n">heap</span>

    <span class="c">(** create an empty heap. *)</span>
    <span class="k">val</span> <span class="n">create</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="n">heap</span>

    <span class="c">(** check a heap is empty. *)</span>
    <span class="k">val</span> <span class="n">is_empty</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">bool</span>
    <span class="c">(** return the size of the heap. *)</span>
    <span class="k">val</span> <span class="n">size</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">int</span>
    <span class="c">(** return the height. *)</span>
    <span class="k">val</span> <span class="n">height</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">int</span>

    <span class="c">(** insert a new key. *)</span>
    <span class="k">val</span> <span class="n">insert</span> <span class="p">:</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** remove the last node. *)</span>
    <span class="k">val</span> <span class="n">remove_last_node</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** delete the root. *)</span>
    <span class="k">val</span> <span class="n">remove_min</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** get the root. *)</span>
    <span class="k">val</span> <span class="n">get_min</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">key</span>

    <span class="c">(** create a heap from list. *)</span>
    <span class="k">val</span> <span class="n">of_list</span> <span class="p">:</span> <span class="n">key</span> <span class="kt">list</span> <span class="p">-&gt;</span> <span class="n">heap</span>

    <span class="c">(** heap fold. *)</span>
    <span class="k">val</span> <span class="n">fold_on_min</span> <span class="p">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span>
    <span class="k">val</span> <span class="n">fold_pre_order</span> <span class="p">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span>
      
    <span class="c">(** merge two heaps into one valid heap. *)</span>
    <span class="k">val</span> <span class="n">merge</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** search a key. *)</span>
    <span class="k">val</span> <span class="n">search</span> <span class="p">:</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">bool</span>
      
    <span class="c">(** to string in pre-order. *)</span>
    <span class="k">val</span> <span class="n">to_string</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">string</span>
      
  <span class="k">end</span>

<span class="k">module</span> <span class="nc">Int</span> <span class="p">:</span> <span class="nc">OrderedType</span> <span class="k">with</span> <span class="k">type</span> <span class="n">t</span> <span class="p">=</span> <span class="kt">int</span>

<span class="k">module</span> <span class="nc">Make</span> <span class="p">(</span><span class="nc">El</span> <span class="p">:</span> <span class="nc">OrderedType</span><span class="p">)</span> <span class="p">:</span> <span class="nc">Heap</span> <span class="k">with</span> <span class="k">type</span> <span class="n">key</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">t</span>
</code></pre>
</div>

<div class="language-ocaml highlighter-rouge"><pre class="highlight"><code><span class="k">type</span> <span class="n">order</span> <span class="p">=</span> <span class="nc">Lt</span> <span class="p">|</span> <span class="nc">Eq</span> <span class="p">|</span> <span class="nc">Gt</span>
               
<span class="k">module</span> <span class="k">type</span> <span class="nc">OrderedType</span> <span class="p">=</span>
  <span class="k">sig</span>
    <span class="c">(** the type of the keys. *)</span>
    <span class="k">type</span> <span class="n">t</span>
    <span class="k">val</span> <span class="n">compare</span> <span class="p">:</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="n">order</span>
    <span class="k">val</span> <span class="n">to_string</span> <span class="p">:</span> <span class="n">t</span> <span class="p">-&gt;</span> <span class="kt">string</span>
  <span class="k">end</span>

<span class="k">module</span> <span class="k">type</span> <span class="nc">Heap</span> <span class="p">=</span>
  <span class="k">sig</span>
    <span class="c">(** the type of the elements. *)</span>
    <span class="k">type</span> <span class="n">key</span>
    <span class="c">(** the type of a heap. *)</span>
    <span class="k">type</span> <span class="n">heap</span>

    <span class="c">(** create an empty heap. *)</span>
    <span class="k">val</span> <span class="n">create</span> <span class="p">:</span> <span class="kt">unit</span> <span class="p">-&gt;</span> <span class="n">heap</span>

    <span class="c">(** check a heap is empty. *)</span>
    <span class="k">val</span> <span class="n">is_empty</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">bool</span>
    <span class="c">(** return the size of the heap. *)</span>
    <span class="k">val</span> <span class="n">size</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">int</span>
    <span class="c">(** return the height. *)</span>
    <span class="k">val</span> <span class="n">height</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">int</span>
      
    <span class="c">(** insert a new key. *)</span>
    <span class="k">val</span> <span class="n">insert</span> <span class="p">:</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** remove the last node. *)</span>
    <span class="k">val</span> <span class="n">remove_last_node</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** delete the root. *)</span>
    <span class="k">val</span> <span class="n">remove_min</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** get the root. *)</span>
    <span class="k">val</span> <span class="n">get_min</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">key</span>

    <span class="c">(** creat a heap from list. *)</span>
    <span class="k">val</span> <span class="n">of_list</span> <span class="p">:</span> <span class="n">key</span> <span class="kt">list</span> <span class="p">-&gt;</span> <span class="n">heap</span>

    <span class="c">(** heap fold. *)</span>
    <span class="k">val</span> <span class="n">fold_on_min</span> <span class="p">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span>
    <span class="k">val</span> <span class="n">fold_pre_order</span> <span class="p">:</span> <span class="p">(</span><span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="k">'</span><span class="n">a</span>
      
    <span class="c">(** merge two heaps into one valid heap. *)</span>
    <span class="k">val</span> <span class="n">merge</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="n">heap</span>
    <span class="c">(** search a key. *)</span>
    <span class="k">val</span> <span class="n">search</span> <span class="p">:</span> <span class="n">key</span> <span class="p">-&gt;</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">bool</span>
      
    <span class="c">(** to string in pre-order. *)</span>
    <span class="k">val</span> <span class="n">to_string</span> <span class="p">:</span> <span class="n">heap</span> <span class="p">-&gt;</span> <span class="kt">string</span>
      
  <span class="k">end</span>

<span class="k">module</span> <span class="nc">Int</span> <span class="p">=</span>
  <span class="k">struct</span>
    <span class="k">type</span> <span class="n">t</span> <span class="p">=</span> <span class="kt">int</span>
    <span class="k">let</span> <span class="n">to_string</span> <span class="n">x</span> <span class="p">=</span> <span class="n">string_of_int</span> <span class="n">x</span>
    <span class="k">let</span> <span class="n">compare</span> <span class="n">x</span> <span class="n">y</span> <span class="p">=</span>
      <span class="k">if</span> <span class="n">x</span> <span class="p">&gt;</span> <span class="n">y</span> <span class="k">then</span>
        <span class="nc">Gt</span>
      <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">y</span> <span class="k">then</span>
        <span class="nc">Lt</span>
      <span class="k">else</span>
        <span class="nc">Eq</span>
  <span class="k">end</span>
  
<span class="k">module</span> <span class="nc">Make</span> <span class="p">(</span><span class="nc">El</span> <span class="p">:</span> <span class="nc">OrderedType</span><span class="p">)</span> <span class="p">=</span>
  <span class="k">struct</span>
    <span class="k">type</span> <span class="n">key</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">t</span>
    <span class="c">(** a node contains # nodes, height, left tree, key, and right tree. *)</span>
             
    <span class="k">type</span> <span class="n">heap</span> <span class="p">=</span> <span class="nc">Leaf</span>
                <span class="p">|</span> <span class="nc">Node</span> <span class="k">of</span> <span class="kt">int</span> <span class="p">*</span> <span class="kt">int</span> <span class="p">*</span> <span class="n">heap</span> <span class="p">*</span> <span class="nn">El</span><span class="p">.</span><span class="n">t</span> <span class="p">*</span> <span class="n">heap</span>

    <span class="k">let</span> <span class="n">create</span> <span class="bp">()</span> <span class="p">=</span>
      <span class="nc">Leaf</span>

    <span class="k">let</span> <span class="n">is_empty</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="bp">true</span>
      <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">false</span>

    <span class="k">let</span> <span class="n">size</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="mi">0</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">_,</span> <span class="o">_,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="n">n</span>

    <span class="k">let</span> <span class="n">height</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="mi">0</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="n">h</span><span class="p">,</span> <span class="o">_,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="n">h</span>
                              
    <span class="c">(** Insert x into a heap (n, h, tree).
      * Since 2^h &lt;= n &lt;= 2^(h+1) - 1, 
      * if n = 2^(h+1) - 1 (the tree is perfect complete
      * then insert to the left tree
      * or if 2^h &lt;= n &lt; 2^h + 2^(h-1) (the left tree is
      * not full then insert to the left tree
      * else insert to the right tree.
      * 
      * 1. Add the new key to the bottom level of the heap
      * 2. Compare the added key with its parent,
      * if they are in the correct order, then stop
      * 3. If not, swap it with its parent, then goto 2.
      *)</span>

    <span class="k">let</span> <span class="n">insert_to_left</span> <span class="n">n</span> <span class="n">h</span> <span class="p">=</span>
      <span class="k">let</span> <span class="n">lb</span> <span class="p">=</span> <span class="mi">1</span> <span class="ow">lsl</span> <span class="n">h</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">up</span> <span class="p">=</span> <span class="mi">1</span> <span class="ow">lsl</span> <span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="p">=</span> <span class="n">up</span> <span class="p">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">lb</span> <span class="p">&amp;&amp;</span> <span class="n">n</span> <span class="p">&lt;</span> <span class="p">(</span><span class="n">lb</span> <span class="o">+</span> <span class="n">lb</span><span class="o">/</span><span class="mi">2</span> <span class="p">-</span> <span class="mi">1</span><span class="o">))</span> <span class="k">then</span>
        <span class="bp">true</span>
      <span class="k">else</span>
        <span class="bp">false</span>

    <span class="k">let</span> <span class="n">compute_new_height</span> <span class="n">n</span> <span class="n">h</span> <span class="p">=</span>
      <span class="k">let</span> <span class="n">up</span> <span class="p">=</span> <span class="mi">1</span> <span class="ow">lsl</span> <span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">n</span> <span class="p">=</span> <span class="n">up</span> <span class="p">-</span> <span class="mi">1</span> <span class="k">then</span>
        <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">else</span>
        <span class="n">h</span>
      
    <span class="k">let</span> <span class="k">rec</span> <span class="n">insert</span> <span class="n">x</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="k">let</span> <span class="n">newh</span> <span class="p">=</span> <span class="n">compute_new_height</span> <span class="n">n</span> <span class="n">h</span> <span class="k">in</span>
         <span class="k">if</span> <span class="n">insert_to_left</span> <span class="n">n</span> <span class="n">h</span> <span class="k">then</span>
           <span class="k">let</span> <span class="n">nlh</span> <span class="p">=</span> <span class="n">insert</span> <span class="n">x</span> <span class="n">l</span> <span class="k">in</span>
           <span class="k">begin</span> <span class="k">match</span> <span class="n">nlh</span> <span class="k">with</span>
           <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
           <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="p">)</span> <span class="k">as</span> <span class="n">nlh</span> <span class="p">-&gt;</span>
              <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">lk</span> <span class="n">k</span> <span class="k">with</span>
              <span class="p">|</span> <span class="nc">Lt</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lr</span><span class="o">),</span> <span class="n">lk</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
              <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
              <span class="k">end</span>
           <span class="k">end</span>
         <span class="k">else</span>
           <span class="k">let</span> <span class="n">nrh</span> <span class="p">=</span> <span class="n">insert</span> <span class="n">x</span> <span class="n">r</span> <span class="k">in</span>
           <span class="k">begin</span> <span class="k">match</span> <span class="n">nrh</span> <span class="k">with</span>
           <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
           <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="p">)</span> <span class="k">as</span> <span class="n">nrh</span> <span class="p">-&gt;</span>
              <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">rk</span> <span class="n">k</span> <span class="k">with</span>
              <span class="p">|</span> <span class="nc">Lt</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span>
              <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nrh</span><span class="p">)</span>
              <span class="k">end</span>
           <span class="k">end</span>

    <span class="c">(** Remove the root from the heap.
      * 1. Replace the root with the last node on the last level of the heap
      * 2. Compare the new root with its children, it they are in the correct
      * order, then stop
      * 3. If not, swap the root with the smallest children, then goto 2
      *)</span>
    <span class="k">let</span> <span class="n">remove_on_left</span> <span class="n">n</span> <span class="n">h</span> <span class="p">=</span>
      <span class="k">let</span> <span class="n">lb</span> <span class="p">=</span> <span class="mi">1</span> <span class="ow">lsl</span> <span class="n">h</span> <span class="k">in</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">lb</span> <span class="p">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">lb</span> <span class="o">+</span> <span class="n">lb</span><span class="o">/</span><span class="mi">2</span> <span class="p">-</span> <span class="mi">1</span><span class="o">))</span> <span class="k">then</span>
        <span class="bp">true</span>
      <span class="k">else</span>
        <span class="bp">false</span>

    <span class="k">let</span> <span class="n">remove_new_height</span> <span class="n">n</span> <span class="n">h</span> <span class="p">=</span>
      <span class="k">let</span> <span class="n">lb</span> <span class="p">=</span> <span class="mi">1</span> <span class="ow">lsl</span> <span class="n">h</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">n</span> <span class="p">=</span> <span class="n">lb</span> <span class="k">then</span>
        <span class="n">h</span> <span class="p">-</span> <span class="mi">1</span>
      <span class="k">else</span>
        <span class="n">h</span>

    <span class="k">let</span> <span class="k">rec</span> <span class="n">heapify</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="k">as</span> <span class="n">ah</span> <span class="p">-&gt;</span> <span class="n">ah</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">as</span> <span class="n">ah</span> <span class="p">-&gt;</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">with</span>
         <span class="p">|</span> <span class="p">(</span><span class="nc">Leaf</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">ah</span>
         <span class="p">|</span> <span class="p">(</span><span class="nc">Leaf</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span> <span class="p">-&gt;</span>
            <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">rk</span> <span class="n">k</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Lt</span> <span class="p">-&gt;</span>
               <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">ah</span>
            <span class="k">end</span>
         <span class="p">|</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="o">),</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span>
            <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">lk</span> <span class="n">k</span> <span class="k">with</span>
            <span class="p">|</span> <span class="nc">Lt</span> <span class="p">-&gt;</span>
               <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lr</span><span class="o">),</span> <span class="n">lk</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
            <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">ah</span>
            <span class="k">end</span>
         <span class="p">|</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="o">),</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span> <span class="p">-&gt;</span>
            <span class="k">let</span> <span class="n">cp1</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">lk</span> <span class="n">k</span> <span class="k">in</span>
            <span class="k">let</span> <span class="n">cp2</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">rk</span> <span class="n">k</span> <span class="k">in</span>
            <span class="k">let</span> <span class="n">cp3</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">lk</span> <span class="n">rk</span> <span class="k">in</span>
            <span class="k">begin</span> <span class="k">match</span> <span class="p">(</span><span class="n">cp1</span><span class="p">,</span><span class="n">cp2</span><span class="p">)</span> <span class="k">with</span>
            <span class="p">|</span> <span class="p">(</span><span class="nc">Lt</span><span class="p">,</span> <span class="o">_)</span> <span class="p">|</span> <span class="o">(_,</span> <span class="nc">Lt</span><span class="p">)</span> <span class="p">-&gt;</span>
               <span class="k">begin</span> <span class="k">match</span> <span class="n">cp3</span> <span class="k">with</span>
               <span class="p">|</span> <span class="nc">Lt</span> <span class="p">-&gt;</span>
                  <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">heapify</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">lr</span><span class="o">)),</span> <span class="n">lk</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span>
               <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
                  <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="o">),</span> <span class="n">rk</span><span class="p">,</span> <span class="n">heapify</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rr</span><span class="o">)))</span>
               <span class="k">end</span>
            <span class="p">|</span> <span class="o">(_,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="n">ah</span>
            <span class="k">end</span>
         <span class="k">end</span>

    <span class="k">let</span> <span class="k">rec</span> <span class="n">remove_last_node_aux</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="nc">None</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="nc">Some</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="k">let</span> <span class="n">newh</span> <span class="p">=</span> <span class="n">remove_new_height</span> <span class="n">n</span> <span class="n">h</span> <span class="k">in</span>
         <span class="k">if</span> <span class="n">remove_on_left</span> <span class="n">n</span> <span class="n">h</span> <span class="k">then</span>
           <span class="k">let</span> <span class="n">onlh</span> <span class="p">=</span> <span class="n">remove_last_node_aux</span> <span class="n">l</span> <span class="k">in</span>
           <span class="k">begin</span> <span class="k">match</span> <span class="n">onlh</span> <span class="k">with</span>
           <span class="p">|</span> <span class="p">(</span><span class="nc">None</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="nc">None</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
           <span class="p">|</span> <span class="p">(</span><span class="nc">Some</span> <span class="n">dk</span><span class="p">,</span> <span class="n">nlh</span><span class="p">)</span> <span class="p">-&gt;</span>
              <span class="p">(</span><span class="nc">Some</span> <span class="n">dk</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">nlh</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="o">))</span>
           <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Remove_last_node_aux: Invalid heap"</span>
           <span class="k">end</span>
         <span class="k">else</span>
           <span class="k">let</span> <span class="n">onrh</span> <span class="p">=</span> <span class="n">remove_last_node_aux</span> <span class="n">r</span> <span class="k">in</span>
           <span class="k">begin</span> <span class="k">match</span> <span class="n">onrh</span> <span class="k">with</span>
           <span class="p">|</span> <span class="p">(</span><span class="nc">None</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="nc">None</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span>
           <span class="p">|</span> <span class="p">(</span><span class="nc">Some</span> <span class="n">dk</span><span class="p">,</span> <span class="n">nrh</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="p">(</span><span class="nc">Some</span> <span class="n">dk</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">newh</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">nrh</span><span class="o">))</span>
           <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Remove_last_node_aux: Invalid heap"</span>
           <span class="k">end</span>
          
    <span class="k">let</span> <span class="n">remove_last_node</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">let</span> <span class="o">(_,</span> <span class="n">h</span><span class="p">)</span> <span class="p">=</span> <span class="n">remove_last_node_aux</span> <span class="n">aheap</span> <span class="k">in</span>
      <span class="n">h</span>
         
    <span class="k">let</span> <span class="n">remove_min</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="nc">Leaf</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Leaf</span>
      <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
         <span class="k">let</span> <span class="p">(</span><span class="n">ok</span><span class="p">,</span> <span class="n">nheap</span><span class="p">)</span> <span class="p">=</span> <span class="n">remove_last_node_aux</span> <span class="n">aheap</span> <span class="k">in</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="n">ok</span> <span class="k">with</span>
         <span class="p">|</span> <span class="nc">None</span> <span class="p">-&gt;</span> <span class="n">nheap</span>
         <span class="p">|</span> <span class="nc">Some</span> <span class="n">dk</span> <span class="p">-&gt;</span> <span class="k">begin</span> <span class="k">match</span> <span class="n">nheap</span> <span class="k">with</span>
                      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">heapify</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">r</span><span class="o">))</span>
                      <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Remove_min: Invalid heap"</span>
                      <span class="k">end</span>
         <span class="k">end</span>
         
    <span class="k">let</span> <span class="n">get_min</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="n">failwith</span> <span class="s2">"Heap is empty"</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="o">_,</span> <span class="n">k</span><span class="p">,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="n">k</span>

    <span class="k">let</span> <span class="n">of_list</span> <span class="n">l</span> <span class="p">=</span>
      <span class="k">let</span> <span class="n">h</span> <span class="p">=</span> <span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="p">(</span><span class="k">fun</span> <span class="n">ah</span> <span class="n">k</span> <span class="p">-&gt;</span> <span class="n">insert</span> <span class="n">k</span> <span class="n">ah</span><span class="p">)</span> <span class="n">h</span> <span class="n">l</span>

    <span class="k">let</span> <span class="k">rec</span> <span class="n">fold_on_min</span> <span class="n">f</span> <span class="n">a0</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="n">a0</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="n">fold_on_min</span> <span class="n">f</span> <span class="p">(</span><span class="n">f</span> <span class="n">a0</span> <span class="n">k</span><span class="p">)</span> <span class="p">(</span><span class="n">remove_min</span> <span class="n">aheap</span><span class="p">)</span>

    <span class="k">let</span> <span class="k">rec</span> <span class="n">fold_pre_order</span> <span class="n">f</span> <span class="n">a0</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="n">a0</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="k">let</span> <span class="n">al</span> <span class="p">=</span> <span class="n">fold_pre_order</span> <span class="n">f</span> <span class="p">(</span><span class="n">f</span> <span class="n">a0</span> <span class="n">k</span><span class="p">)</span> <span class="n">l</span> <span class="k">in</span>
         <span class="n">fold_pre_order</span> <span class="n">f</span> <span class="n">al</span> <span class="n">r</span>
         
    <span class="k">let</span> <span class="n">merge</span> <span class="n">heap1</span> <span class="n">heap2</span> <span class="p">=</span>
      <span class="k">match</span> <span class="p">(</span><span class="n">heap1</span><span class="p">,</span> <span class="n">heap2</span><span class="p">)</span> <span class="k">with</span>
      <span class="p">|</span> <span class="p">(</span><span class="nc">Leaf</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Leaf</span>
      <span class="p">|</span> <span class="o">(_,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">heap1</span>
      <span class="p">|</span> <span class="p">(</span><span class="nc">Leaf</span><span class="p">,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="n">heap2</span>
      <span class="p">|</span> <span class="o">(_,</span> <span class="o">_)</span> <span class="p">-&gt;</span>
         <span class="k">let</span> <span class="n">f</span> <span class="n">ah</span> <span class="n">k</span> <span class="p">=</span>
           <span class="n">insert</span> <span class="n">k</span> <span class="n">ah</span>
         <span class="k">in</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="p">(</span><span class="n">get_min</span> <span class="n">heap1</span><span class="p">)</span> <span class="p">(</span><span class="n">get_min</span> <span class="n">heap2</span><span class="p">)</span> <span class="k">with</span>
         <span class="p">|</span> <span class="nc">Lt</span> <span class="p">-&gt;</span>
            <span class="n">fold_pre_order</span> <span class="n">f</span> <span class="n">heap1</span> <span class="n">heap2</span>
         <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span>
            <span class="n">fold_pre_order</span> <span class="n">f</span> <span class="n">heap2</span> <span class="n">heap1</span>
         <span class="k">end</span>

    <span class="k">let</span> <span class="k">rec</span> <span class="n">search</span> <span class="n">x</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">match</span> <span class="n">aheap</span> <span class="k">with</span>
      <span class="p">|</span> <span class="nc">Leaf</span> <span class="p">-&gt;</span> <span class="bp">false</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">k</span> <span class="n">x</span> <span class="k">with</span>
         <span class="p">|</span> <span class="nc">Eq</span> <span class="p">-&gt;</span> <span class="bp">true</span>
         <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="bp">false</span>
         <span class="k">end</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="nc">Leaf</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">k</span> <span class="n">x</span> <span class="k">with</span>
         <span class="p">|</span> <span class="nc">Eq</span> <span class="p">-&gt;</span> <span class="bp">true</span>
         <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">search</span> <span class="n">x</span> <span class="n">r</span>
         <span class="k">end</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Leaf</span><span class="p">)</span> <span class="p">-&gt;</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">k</span> <span class="n">x</span> <span class="k">with</span>
         <span class="p">|</span> <span class="nc">Eq</span> <span class="p">-&gt;</span> <span class="bp">true</span>
         <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="n">search</span> <span class="n">x</span> <span class="n">l</span>
         <span class="k">end</span>
      <span class="p">|</span> <span class="nc">Node</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="o">),</span> <span class="n">k</span><span class="p">,</span> <span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span> <span class="p">-&gt;</span>
         <span class="k">begin</span> <span class="k">match</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">k</span> <span class="n">x</span> <span class="k">with</span>
         <span class="p">|</span> <span class="nc">Eq</span> <span class="p">-&gt;</span> <span class="bp">true</span>
         <span class="p">|</span> <span class="p">_</span> <span class="p">-&gt;</span> <span class="k">let</span> <span class="n">cp1</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">x</span> <span class="n">lk</span> <span class="k">in</span>
                <span class="k">let</span> <span class="n">cp2</span> <span class="p">=</span> <span class="nn">El</span><span class="p">.</span><span class="n">compare</span> <span class="n">x</span> <span class="n">rk</span> <span class="k">in</span>
                <span class="k">begin</span> <span class="k">match</span> <span class="p">(</span><span class="n">cp1</span><span class="p">,</span> <span class="n">cp2</span><span class="p">)</span> <span class="k">with</span>
                <span class="p">|</span> <span class="p">(</span><span class="nc">Eq</span><span class="p">,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="bp">true</span>
                <span class="p">|</span> <span class="p">(</span><span class="nc">Lt</span><span class="p">,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="n">search</span> <span class="n">x</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span>
                <span class="p">|</span> <span class="o">(_,</span> <span class="nc">Eq</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="bp">true</span>
                <span class="p">|</span> <span class="o">(_,</span> <span class="nc">Lt</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">search</span> <span class="n">x</span>  <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="o">))</span>
                <span class="p">|</span> <span class="o">(_,</span> <span class="o">_)</span> <span class="p">-&gt;</span> <span class="k">if</span> <span class="p">(</span><span class="n">search</span> <span class="n">x</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">lh</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lk</span><span class="p">,</span> <span class="n">lr</span><span class="o">)))</span> <span class="k">then</span>
                              <span class="bp">true</span>
                            <span class="k">else</span> <span class="n">search</span> <span class="n">x</span> <span class="p">(</span><span class="nc">Node</span> <span class="p">(</span><span class="n">rn</span><span class="p">,</span> <span class="n">rh</span><span class="p">,</span> <span class="n">rl</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">rr</span><span class="o">))</span>
                <span class="k">end</span>
         <span class="k">end</span>
        
    <span class="k">let</span> <span class="n">to_string</span> <span class="n">aheap</span> <span class="p">=</span>
      <span class="k">let</span> <span class="n">f</span> <span class="n">s</span> <span class="n">k</span> <span class="p">=</span> <span class="n">s</span> <span class="o">^</span> <span class="p">(</span><span class="nn">El</span><span class="p">.</span><span class="n">to_string</span> <span class="n">k</span><span class="p">)</span>
      <span class="k">in</span>
      <span class="n">fold_pre_order</span> <span class="n">f</span> <span class="s2">""</span> <span class="n">aheap</span>
      
  <span class="k">end</span>
</code></pre>
</div>


  </article>
</div>
<!--
<div class="share-buttons">
  <h6>Share on: </h6>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://channgo2203.github.io/articles/2016-12/heap" class="twitter btn" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://channgo2203.github.io/articles/2016-12/heap" class="facebook btn" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://channgo2203.github.io/articles/2016-12/heap" class="google-plus btn" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
    <li>
      <a href="https://news.ycombinator.com/submitlink?u=http://channgo2203.github.io/articles/2016-12/heap" class="hacker-news btn" title="Share on Hacker News"><i class="fa fa-hacker-news"></i><span> Hacker News</span></a>
    </li>
    <li>
      <a href="https://www.reddit.com/submit?url=http://channgo2203.github.io/articles/2016-12/heap" class="reddit btn" title="Share on Reddit"><i class="fa fa-reddit"></i><span> Reddit</span></a>
    </li>
  </ul>
</div>-->


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = 'channgo';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



        <footer>
  &copy; 2017 Van Chan Ngo. Powered by <a href="http://jekyllrb.com/">Jekyll</a>, <a href="http://github.com/renyuanz/leonids/">leonids theme</a>
</footer>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="http://channgo2203.github.io/js/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="http://channgo2203.github.io/js/main.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89119753-1', 'auto');
  ga('send', 'pageview');
</script>


</body>

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MFGCXMJ"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
  
</html>
